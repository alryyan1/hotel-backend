# نظام تنبيهات النظافة - Cleaning Notifications System

## نظرة عامة

نظام تنبيهات النظافة يقوم بإنشاء تنبيهات تلقائية لتنظيف الغرف في حالتين:

1. **بعد تسجيل المغادرة**: عند تسجيل مغادرة العميل، يتم إنشاء تنبيه تنظيف تلقائيًا للغرفة
2. **دوري (كل يومين)**: للغرف المشغولة، يتم إنشاء تنبيه تنظيف كل يومين بدءًا من اليوم الثاني

## المكونات

### 1. جدول قاعدة البيانات
- `cleaning_notifications`: يحتوي على جميع التنبيهات
- الحقول: `room_id`, `reservation_id`, `type`, `status`, `notes`, `notified_at`, `completed_at`

### 2. الأمر المجدول
- **الأمر**: `php artisan cleaning:check-notifications`
- **الوصف**: يتحقق من الغرف المشغولة وينشئ تنبيهات دورية كل يومين
- **التكرار**: يعمل يوميًا تلقائيًا (إذا كان cron job مفعّل)

### 3. API Endpoints
- `GET /api/cleaning-notifications` - قائمة التنبيهات
- `GET /api/cleaning-notifications/count` - عدد التنبيهات المعلقة
- `POST /api/cleaning-notifications/{id}/complete` - إكمال التنبيه
- `POST /api/cleaning-notifications/{id}/dismiss` - إلغاء التنبيه

### 4. الواجهة الأمامية
- صفحة `/cleaning-notifications` لعرض وإدارة التنبيهات

---

## كيفية الاستخدام

### 1. التشغيل اليدوي

لتشغيل الأمر يدويًا والتحقق من التنبيهات:

```bash
cd C:\xampp\htdocs\hotel-backend
php artisan cleaning:check-notifications
```

**النتيجة المتوقعة:**
```
Checking for cleaning notifications...
Created X cleaning notification(s).
```

### 2. التشغيل التلقائي (Cron Job)

لجعل النظام يعمل تلقائيًا يوميًا، يجب إعداد cron job:

#### على Linux/Unix:

1. افتح crontab:
```bash
crontab -e
```

2. أضف السطر التالي (استبدل المسار بالمسار الصحيح لمشروعك):
```cron
* * * * * cd /path-to-your-project/hotel-backend && php artisan schedule:run >> /dev/null 2>&1
```

#### على Windows (Task Scheduler):

1. افتح Task Scheduler
2. أنشئ مهمة جديدة
3. في "Action"، اختر "Start a program"
4. البرنامج: `C:\xampp\php\php.exe`
5. الإعدادات: `artisan schedule:run`
6. المجلد: `C:\xampp\htdocs\hotel-backend`
7. التكرار: كل دقيقة

---

## كيفية التحقق من أن النظام يعمل بشكل صحيح

### 1. اختبار التنبيهات بعد المغادرة

**الخطوات:**
1. أنشئ حجزًا جديدًا
2. سجّل دخول العميل (Check-in)
3. سجّل مغادرة العميل (Check-out)
4. تحقق من صفحة تنبيهات النظافة

**النتيجة المتوقعة:**
- يجب أن يظهر تنبيه جديد من نوع "بعد المغادرة" (checkout)
- الحالة: "قيد الانتظار" (pending)

### 2. اختبار التنبيهات الدورية

**الخطوات:**
1. أنشئ حجزًا جديدًا بتاريخ دخول قبل يومين أو أكثر
2. تأكد أن الحجز في حالة "checked_in"
3. شغّل الأمر يدويًا:
   ```bash
   php artisan cleaning:check-notifications
   ```
4. تحقق من صفحة تنبيهات النظافة

**النتيجة المتوقعة:**
- إذا مر يومان أو مضاعفاتهما (2, 4, 6, 8... أيام) منذ تاريخ الدخول
- يجب أن يظهر تنبيه جديد من نوع "دوري (كل يومين)" (periodic)
- الحالة: "قيد الانتظار" (pending)

### 3. التحقق من قاعدة البيانات

يمكنك التحقق مباشرة من قاعدة البيانات:

```sql
SELECT * FROM cleaning_notifications ORDER BY created_at DESC;
```

**الحقول المهمة:**
- `type`: `checkout` أو `periodic`
- `status`: `pending`, `completed`, أو `dismissed`
- `notified_at`: تاريخ إنشاء التنبيه
- `completed_at`: تاريخ إكمال التنبيه (إذا تم إكماله)

### 4. التحقق من API

**جلب جميع التنبيهات:**
```bash
curl -X GET "http://127.0.0.1/hotel-backend/public/api/cleaning-notifications" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**جلب عدد التنبيهات المعلقة:**
```bash
curl -X GET "http://127.0.0.1/hotel-backend/public/api/cleaning-notifications/count" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## سيناريوهات الاختبار

### السيناريو 1: غرفة مشغولة لمدة يومين

1. **إنشاء حجز:**
   - تاريخ الدخول: قبل يومين (مثلاً: 2025-12-09)
   - تاريخ المغادرة: بعد أسبوع (مثلاً: 2025-12-16)
   - الحالة: `checked_in`

2. **تشغيل الأمر:**
   ```bash
   php artisan cleaning:check-notifications
   ```

3. **النتيجة:**
   - يجب إنشاء تنبيه دوري للغرفة
   - النوع: `periodic`
   - الحالة: `pending`

### السيناريو 2: غرفة مشغولة لمدة 4 أيام

1. **إنشاء حجز:**
   - تاريخ الدخول: قبل 4 أيام (مثلاً: 2025-12-07)
   - تاريخ المغادرة: بعد أسبوع
   - الحالة: `checked_in`

2. **تشغيل الأمر:**
   ```bash
   php artisan cleaning:check-notifications
   ```

3. **النتيجة:**
   - يجب إنشاء تنبيه دوري (لأن 4 هو مضاعف لـ 2)
   - إذا كان هناك تنبيه موجود من اليوم، لن يتم إنشاء تنبيه جديد

### السيناريو 3: تسجيل المغادرة

1. **تسجيل مغادرة حجز:**
   - استخدم API أو الواجهة الأمامية لتسجيل المغادرة

2. **النتيجة التلقائية:**
   - يتم إنشاء تنبيه تنظيف تلقائيًا
   - النوع: `checkout`
   - الحالة: `pending`

---

## استكشاف الأخطاء وحلها

### المشكلة: لا يتم إنشاء تنبيهات

**التحقق:**
1. تأكد من وجود حجوزات بحالة `checked_in`
2. تحقق من تواريخ الدخول والمغادرة
3. شغّل الأمر يدويًا وراقب الرسائل:
   ```bash
   php artisan cleaning:check-notifications
   ```

**الحلول المحتملة:**
- تأكد من أن الحجوزات في حالة `checked_in`
- تحقق من أن تواريخ الدخول صحيحة
- تأكد من أن الغرف مرتبطة بالحجوزات بشكل صحيح

### المشكلة: يتم إنشاء تنبيهات مكررة

**السبب:**
- قد يكون هناك تنبيه موجود بالفعل من نفس اليوم

**الحل:**
- النظام يتحقق تلقائيًا من وجود تنبيهات من نفس اليوم قبل الإنشاء
- إذا ظهرت تنبيهات مكررة، تحقق من منطق التحقق في الأمر

### المشكلة: التنبيهات الدورية لا تعمل

**التحقق:**
1. تأكد من أن الحجز موجود منذ يومين أو أكثر
2. تحقق من أن عدد الأيام مضاعف لـ 2 (2, 4, 6, 8...)
3. شغّل الأمر يدويًا:
   ```bash
   php artisan cleaning:check-notifications
   ```

**مثال:**
- إذا كان تاريخ الدخول قبل 3 أيام، لن يتم إنشاء تنبيه (لأن 3 ليس مضاعف لـ 2)
- إذا كان تاريخ الدخول قبل 4 أيام، سيتم إنشاء تنبيه (لأن 4 مضاعف لـ 2)

### المشكلة: Cron Job لا يعمل

**التحقق:**
1. تأكد من أن cron job مفعّل:
   ```bash
   crontab -l
   ```

2. تحقق من سجلات cron:
   ```bash
   tail -f /var/log/cron.log
   ```

**الحل:**
- أعد إعداد cron job كما هو موضح في قسم "التشغيل التلقائي"
- على Windows، استخدم Task Scheduler

---

## ملاحظات مهمة

1. **التنبيهات الدورية:**
   - يتم إنشاؤها فقط عندما يكون عدد الأيام منذ الدخول مضاعفًا لـ 2
   - يتم التحقق من عدم وجود تنبيه من نفس اليوم قبل الإنشاء

2. **التنبيهات بعد المغادرة:**
   - يتم إنشاؤها تلقائيًا عند تسجيل المغادرة
   - لا تحتاج إلى تشغيل الأمر يدويًا

3. **إدارة التنبيهات:**
   - يمكن إكمال التنبيهات من الواجهة الأمامية
   - يمكن إلغاء التنبيهات غير المطلوبة
   - يمكن إضافة ملاحظات عند إكمال التنبيه

4. **الأداء:**
   - الأمر مصمم للعمل بسرعة حتى مع عدد كبير من الغرف
   - يستخدم eager loading لتحسين الأداء

---

## الأوامر المفيدة

```bash
# تشغيل الأمر يدويًا
php artisan cleaning:check-notifications

# عرض جميع الأوامر المتاحة
php artisan list

# عرض تفاصيل الأمر
php artisan help cleaning:check-notifications

# اختبار الاتصال بقاعدة البيانات
php artisan tinker
>>> \App\Models\CleaningNotification::count()
```

---

## الدعم

إذا واجهت أي مشاكل:
1. تحقق من سجلات Laravel: `storage/logs/laravel.log`
2. شغّل الأمر يدويًا وراقب الرسائل
3. تحقق من قاعدة البيانات مباشرة
4. راجع هذا الملف للتحقق من الخطوات

---

**آخر تحديث:** 2025-12-11

